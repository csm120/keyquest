(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(n){if(n.ep)return;n.ep=!0;const s=t(n);fetch(n.href,s)}})();const y="kq:theme";function w(){return matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function m(i){document.documentElement.setAttribute("data-theme",i);try{localStorage.setItem(y,i)}catch{}const e=document.querySelector(`input[name="theme"][value="${i}"]`);e&&(e.checked=!0)}function v(){let i=w();try{const e=localStorage.getItem(y);e&&(i=e)}catch{}m(i),document.querySelectorAll('input[name="theme"]').forEach(e=>{e.addEventListener("change",()=>m(e.value))});try{localStorage.getItem(y)||matchMedia("(prefers-color-scheme: dark)").addEventListener?.("change",()=>m(w()))}catch{}}function b(i){const e=i.getTime()-Date.now(),t=Math.abs(e)/1e3;if(t<30)return"just now";const r=[["year",31536e3],["month",2592e3],["day",86400],["hour",3600],["minute",60]],n=typeof Intl<"u"&&"RelativeTimeFormat"in Intl?new Intl.RelativeTimeFormat(void 0,{numeric:"auto",style:"narrow"}):null;for(const[s,o]of r)if(t>=o||s==="minute"){const a=Math.round(e/o);return n?n.format(a,s):`${Math.max(1,Math.abs(Math.round(e/60)))}m ago`}return"just now"}async function L(){try{const i=await fetch("build.json",{cache:"no-store"});if(!i.ok)return;const e=await i.json(),t=String(e.commit||"").slice(0,7)||"unknown",r=new Date(String(e.built||Date.now())),n=document.getElementById("buildInfo");if(!n)return;let s=null;const o=()=>{n.textContent=`Deployed ${t} · ${b(r)}`;try{n.setAttribute("title",r.toLocaleString())}catch{}n.setAttribute("aria-live","off")};o(),s=window.setInterval(o,6e4);const a=()=>{s!==null&&(clearInterval(s),s=null)};document.addEventListener("visibilitychange",()=>{document.hidden&&a()},{once:!0}),window.addEventListener("beforeunload",a)}catch{}}class A{constructor(){this.enabled=!0,this.priorityUntil=0,this.synth=window.speechSynthesis,this.currentUtterance=null}say(e,t=!1,r=0){if(!this.enabled||!e)return;const n=Date.now();if(t)this.priorityUntil=n+r*1e3,this.synth.cancel();else if(n<this.priorityUntil)return;try{const s=new SpeechSynthesisUtterance(e);s.rate=1,s.pitch=1,s.volume=1,this.currentUtterance=s,this.synth.speak(s)}catch(s){console.error("Speech error:",s),console.log("Speech:",e)}}cancel(){this.synth.cancel()}toggle(){return this.enabled=!this.enabled,this.enabled||this.cancel(),this.enabled}}class k{constructor(){this.context=null;try{this.context=new(window.AudioContext||window.webkitAudioContext)}catch{console.warn("Web Audio API not available")}}playTone(e,t){if(this.context)try{const r=this.context.createOscillator(),n=this.context.createGain();r.connect(n),n.connect(this.context.destination),r.frequency.value=e,r.type="sine";const s=this.context.currentTime;n.gain.setValueAtTime(0,s),n.gain.linearRampToValueAtTime(.3,s+.01),n.gain.linearRampToValueAtTime(0,s+t),r.start(s),r.stop(s+t)}catch(r){console.error("Audio error:",r)}}beepOk(){this.playTone(1200,.07)}beepBad(){this.playTone(300,.1)}}class M{constructor(){this.mode="MENU",this.menuIndex=0,this.menuItems=["Tutorial","Lesson","Speed Test","Quit"],this.lesson={stage:0,batchWords:[],index:0,typed:""},this.tutorial={phase:1,sequence:[],index:0,requiredName:"",requiredKey:"",countsDone:{}},this.test={running:!1,startTime:0,current:"",remaining:[],typed:"",correctChars:0,totalChars:0},this.resultsText=""}}const x="keyquest:progress";function I(){try{const i=localStorage.getItem(x);if(i){const e=JSON.parse(i);return{stage:parseInt(e.stage,10)||0}}}catch(i){console.warn("Could not load progress:",i)}return{stage:0}}function E(i){try{const e={stage:parseInt(i,10)};localStorage.setItem(x,JSON.stringify(e))}catch(e){console.error("Could not save progress:",e)}}const D=8,u=60,$=["Keep going.","Stay relaxed.","Type with care.","Small steps add up.","Find a steady pace.","Focus and breathe.","Hands on home row.","Make few errors.","Stay calm.","You can do this."],h=[["a","s","d","f"],["j","k"],["l",";"],["g","h"],["q","w","e","r"],["u","i","o","p"],["z","x","c","v"],["n","m"],["b"],["t","y"],["1","2","3","4","5"],["6","7","8","9","0"],[",",".","'","/"]],f=3,d=[["up","ArrowUp"],["down","ArrowDown"],["left","ArrowLeft"],["right","ArrowRight"],["space"," "]],g=[...d,["enter","Enter"]],l={up:"Up Arrow",down:"Down Arrow",left:"Left Arrow",right:"Right Arrow",space:"Space bar",enter:"Enter"},q={up:"Arrow pointing up, above the Down Arrow.",down:"Arrow pointing down, below the Up Arrow.",left:"Arrow pointing left, to the left of Right.",right:"Arrow pointing right, to the right of Left.",space:"Long bar in the middle at the bottom of the keyboard.",enter:"Large key on the right side of the letters; often tall or L‑shaped."},C={"up-down":"Try Down — one step below.","down-up":"Try Up — one step above.","left-right":"Try Right — the opposite direction.","right-left":"Try Left — the opposite direction.","space-up":"Try Up Arrow — above the Down key cluster.","space-down":"Try Down Arrow — below the Up key.","space-left":"Try Left Arrow — to the left of Right.","space-right":"Try Right Arrow — to the right of Left.","up-enter":"Try Enter — on the right side of the keyboard.","down-enter":"Try Enter — on the right side.","left-enter":"Try Enter — near the right edge, often tall.","right-enter":"Try Enter — just to your right from the letters.","enter-space":"Try Space — the long bar at the bottom."};class R{constructor(){this.state=new M,this.speech=new A,this.audio=new k,this.statusEl=document.getElementById("status"),this.alertsEl=document.getElementById("alerts"),this.rootEl=document.getElementById("game-root");const e=I();this.state.lesson.stage=Math.max(0,Math.min(e.stage,h.length-1)),document.addEventListener("keydown",t=>this.handleKeyDown(t))}announceStatus(e){this.statusEl.textContent="",setTimeout(()=>{this.statusEl.textContent=e},10)}announceAlert(e,t=!1,r=0){this.alertsEl.textContent="",setTimeout(()=>{this.alertsEl.textContent=e},10),this.speech.say(e,t,r)}start(){this.showMenu()}handleKeyDown(e){switch(this.state.mode){case"MENU":this.handleMenuKey(e);break;case"TUTORIAL":this.handleTutorialKey(e);break;case"LESSON":this.handleLessonKey(e);break;case"TEST":this.handleTestKey(e);break;case"RESULTS":this.handleResultsKey(e);break}}showMenu(){this.state.mode="MENU",this.state.menuIndex=0;const e=this.state.lesson.stage+1,t=h.length;this.rootEl.innerHTML=`
      <div style="max-width:600px;margin:2rem auto;text-align:center;">
        <h2>Main Menu</h2>
        <div id="menu-list" role="menu" style="margin:2rem 0;">
          ${this.state.menuItems.map((s,o)=>`<div role="menuitem" data-index="${o}" style="padding:1rem;margin:0.5rem 0;background:${o===0?"var(--hilite, #444)":"var(--bg)"};border:2px solid var(--fg);">${s}</div>`).join("")}
        </div>
        <p class="muted">Current Stage: ${e} / ${t}</p>
        <p class="muted">Use Up/Down to navigate, Enter or Space to select</p>
      </div>
    `,this.updateMenuHighlight();const n=this.state.menuItems[this.state.menuIndex];this.announceAlert(`Key Quest. Main menu. ${n}. Use Up and Down to choose. Press Enter or Space to select.`,!0,2)}updateMenuHighlight(){this.rootEl.querySelectorAll('[role="menuitem"]').forEach((t,r)=>{t.style.background=r===this.state.menuIndex?"var(--hilite, #444)":"transparent"})}handleMenuKey(e){if(e.key!=="Escape"){if(e.key==="ArrowUp")e.preventDefault(),this.state.menuIndex=(this.state.menuIndex-1+this.state.menuItems.length)%this.state.menuItems.length,this.updateMenuHighlight(),this.speech.say(this.state.menuItems[this.state.menuIndex]);else if(e.key==="ArrowDown")e.preventDefault(),this.state.menuIndex=(this.state.menuIndex+1)%this.state.menuItems.length,this.updateMenuHighlight(),this.speech.say(this.state.menuItems[this.state.menuIndex]);else if(e.key==="Enter"||e.key===" "){e.preventDefault();const t=this.state.menuItems[this.state.menuIndex];t==="Tutorial"?this.startTutorial():t==="Lesson"?this.startLesson():t==="Speed Test"?this.startTest():t==="Quit"&&(this.announceAlert("Goodbye!",!0),setTimeout(()=>{window.close()},1e3))}}}startTutorial(){this.state.mode="TUTORIAL";const e=this.state.tutorial;e.phase=1,e.sequence=[],e.countsDone={};for(const[t,r]of d)for(let n=0;n<f;n++)e.sequence.push([t,r]);for(let t=e.sequence.length-1;t>0;t--){const r=Math.floor(Math.random()*(t+1));[e.sequence[t],e.sequence[r]]=[e.sequence[r],e.sequence[t]]}e.index=0,this.renderTutorial(),this.announceAlert("Tutorial. First: arrows and the space bar, three each. Arrows are together: Up above Down, Left beside Right. Space is the long bar at the bottom.",!0,2.5),this.loadTutorialPrompt()}renderTutorial(){const e=this.state.tutorial,t=e.phase===1?d:g;this.rootEl.innerHTML=`
      <div style="max-width:700px;margin:2rem auto;text-align:center;">
        <h2>Tutorial - Phase ${e.phase}</h2>
        <div style="margin:2rem 0;font-size:2rem;padding:2rem;border:3px solid var(--fg);">
          Press: <strong id="tutorial-prompt">...</strong>
        </div>
        <div style="margin:2rem 0;">
          <h3>Progress:</h3>
          ${t.map(([r])=>{const n=e.countsDone[r]||0;return`<p>${l[r]}: ${n}/${f}</p>`}).join("")}
        </div>
        <p class="muted">Ctrl+Space to repeat prompt, Escape to return to menu</p>
      </div>
    `}loadTutorialPrompt(){const e=this.state.tutorial;if(e.index>=e.sequence.length)if(e.phase===1){e.phase=2,e.sequence=[];for(const[s,o]of g)for(let a=0;a<f;a++)e.sequence.push([s,o]);for(let s=e.sequence.length-1;s>0;s--){const o=Math.floor(Math.random()*(s+1));[e.sequence[s],e.sequence[o]]=[e.sequence[o],e.sequence[s]]}e.index=0,this.renderTutorial(),this.announceAlert("Great! Now also use Enter. Enter is on the right side of the letters, often tall or L‑shaped.",!0,2.5),this.loadTutorialPrompt();return}else{this.announceAlert("Tutorial complete. Returning to menu.",!0),setTimeout(()=>this.showMenu(),1500);return}const[t,r]=e.sequence[e.index];e.requiredName=t,e.requiredKey=r;const n=document.getElementById("tutorial-prompt");n&&(n.textContent=l[t]),this.speech.say(`Press ${l[t]}.`)}handleTutorialKey(e){if(e.key==="Escape"){this.showMenu();return}if(e.key===" "&&e.ctrlKey){e.preventDefault();const s=this.state.tutorial;this.speech.say(`Press ${l[s.requiredName]}.`);return}const t=this.state.tutorial,r=t.phase===1?d:g;let n=null;for(const[s,o]of r)if(e.key===o){n=s;break}if(n===null){t.phase===1?this.speech.say("Use the arrow keys or the space bar."):this.speech.say("Use arrows, space, or Enter.");return}if(e.key===t.requiredKey){e.preventDefault(),this.audio.beepOk(),t.countsDone[t.requiredName]=(t.countsDone[t.requiredName]||0)+1,t.index++;const s=["Good.","Nice.","Correct."];this.speech.say(s[Math.floor(Math.random()*s.length)]),this.renderTutorial(),setTimeout(()=>{this.loadTutorialPrompt()},500)}else{e.preventDefault(),this.audio.beepBad();const s=t.requiredName,o=n,a=`${o}-${s}`,p=C[a]||`Try ${l[s]}.`,c=q[s];this.speech.say(`${l[o]}. ${p} ${c}`)}}startLesson(){this.state.mode="LESSON";const e=this.state.lesson.stage;this.state.lesson.index=0,this.state.lesson.typed="",this.buildLessonBatch(),this.renderLesson();const t=new Set;for(let n=0;n<=e;n++)h[n].forEach(s=>t.add(s));const r=Array.from(t).sort().join(", ");this.announceAlert(`Lesson Stage ${e+1}. Practice keys: ${r}. Control Space repeats the prompt.`,!0,2),setTimeout(()=>{this.lessonPrompt()},1500)}buildLessonBatch(){const e=this.state.lesson.stage,t=new Set;for(let s=0;s<=e;s++)h[s].forEach(o=>t.add(o));const r=Array.from(t).sort(),n=[];for(let s=0;s<D;s++){const a=e<2?4:5,p=Math.floor(Math.random()*(a-1+1))+1;let c="";for(let T=0;T<p;T++)c+=r[Math.floor(Math.random()*r.length)];n.push(c)}this.state.lesson.batchWords=n}renderLesson(){const e=this.state.lesson,t=e.batchWords[e.index]||"",r=e.stage,n=new Set;for(let o=0;o<=r;o++)h[o].forEach(a=>n.add(a));const s=Array.from(n).sort().join(", ");this.rootEl.innerHTML=`
      <div style="max-width:700px;margin:2rem auto;text-align:center;">
        <h2>Lesson - Stage ${r+1}</h2>
        <p class="muted">Keys: ${s}</p>
        <div style="margin:2rem 0;font-size:2.5rem;padding:2rem;border:3px solid var(--accent, #9ec1ff);">
          <div id="lesson-target">${t}</div>
        </div>
        <div style="font-size:2rem;padding:1rem;min-height:3rem;border:2px solid var(--fg);">
          <span id="lesson-typed">${e.typed}</span>
        </div>
        <p style="margin-top:2rem;">Item ${e.index+1} of ${e.batchWords.length}</p>
        <p class="muted">Ctrl+Space repeats prompt | Escape returns to menu</p>
      </div>
    `}lessonPrompt(){const e=this.state.lesson.batchWords[this.state.lesson.index];this.speech.say(`Type: ${e}`,!0)}nextLessonItem(){this.state.lesson.index++,this.state.lesson.typed="",this.state.lesson.index>=this.state.lesson.batchWords.length?this.showLessonResults():(this.renderLesson(),setTimeout(()=>{this.lessonPrompt()},500))}showLessonResults(){this.state.mode="RESULTS";const e=this.state.lesson.stage;e+1<h.length?this.state.resultsText=`Great job! You completed stage ${e+1}. Press Space to add new keys, Enter to repeat this stage, or Escape for menu.`:this.state.resultsText="Excellent! You have mastered all stages. Press Enter to practice this stage again or Escape for menu.",this.renderResults(),this.announceAlert(this.state.resultsText,!0,3)}handleLessonKey(e){if(e.key==="Escape"){this.showMenu();return}if(e.key===" "&&e.ctrlKey){e.preventDefault(),this.lessonPrompt();return}if(e.key==="Backspace"){e.preventDefault(),this.state.lesson.typed=this.state.lesson.typed.slice(0,-1),this.renderLesson();return}if(e.key.length===1&&e.key.match(/[a-z0-9;,.'\/\s]/i)){e.preventDefault();const t=e.key,r=this.state.lesson.batchWords[this.state.lesson.index];this.state.lesson.typed+=t;const n=this.state.lesson.typed;if(!r.startsWith(n)){this.audio.beepBad();const s=this.state.lesson.typed.slice(0,-1),o=s.length>0&&r.startsWith(s)?r.substring(s.length):r;this.state.lesson.typed="",this.renderLesson(),this.speech.say(`Remaining: ${o}`,!0);return}n===r?(this.audio.beepOk(),this.nextLessonItem()):this.renderLesson()}}startTest(){this.state.mode="TEST";const e=[...$];for(let t=e.length-1;t>0;t--){const r=Math.floor(Math.random()*(t+1));[e[t],e[r]]=[e[r],e[t]]}this.state.test={running:!1,startTime:0,current:"",remaining:e,typed:"",correctChars:0,totalChars:0},this.renderTest(),this.announceAlert("Speed test. Sixty seconds. Control Space repeats the remaining text.",!0,2),setTimeout(()=>{this.loadNextSentence()},1500)}loadNextSentence(){if(this.state.test.remaining.length===0){this.finishTest();return}this.state.test.current=this.state.test.remaining.shift(),this.state.test.typed="",this.renderTest(),this.speech.say(this.state.test.current)}renderTest(){const e=this.state.test;let t=u;if(e.startTime>0){const r=(Date.now()-e.startTime)/1e3;t=Math.max(0,u-r)}this.rootEl.innerHTML=`
      <div style="max-width:700px;margin:2rem auto;text-align:center;">
        <h2>Speed Test</h2>
        <div style="margin:2rem 0;font-size:1.5rem;color:var(--accent, #9ec1ff);">
          ${e.current}
        </div>
        <div style="font-size:2rem;padding:1rem;min-height:3rem;border:2px solid var(--fg);">
          ${e.typed}
        </div>
        <p style="margin-top:2rem;font-size:1.5rem;">Time: ${Math.ceil(t)}s</p>
        <p class="muted">Ctrl+Space repeats text | Escape returns to menu</p>
      </div>
    `,e.startTime>0&&t>0&&setTimeout(()=>{this.state.mode==="TEST"&&this.state.test.startTime>0&&((Date.now()-this.state.test.startTime)/1e3>=u?this.finishTest():this.renderTest())},1e3)}finishTest(){const e=this.state.test;e.running=!1;const t=e.totalChars>0?e.correctChars/e.totalChars*100:0,r=e.startTime>0?(Date.now()-e.startTime)/1e3:u,n=e.correctChars/5,s=r/60,o=s>0?n/s:0;this.state.mode="RESULTS",this.state.resultsText=`Speed test complete. WPM ${o.toFixed(1)}. Accuracy ${t.toFixed(1)} percent. Press Enter to repeat, or Escape for menu.`,this.renderResults(),this.announceAlert(this.state.resultsText,!0,3)}handleTestKey(e){if(e.key==="Escape"){this.showMenu();return}if(e.key===" "&&e.ctrlKey){e.preventDefault();const r=this.state.test.current,n=this.state.test.typed,s=r.substring(n.length);this.speech.say(s||r,!0);return}const t=this.state.test;if(!t.startTime&&e.key.length===1&&(t.startTime=Date.now(),t.running=!0),e.key==="Backspace"){e.preventDefault(),t.typed=t.typed.slice(0,-1),this.renderTest();return}if(e.key.length===1){e.preventDefault();const r=e.key,n=t.typed.length;t.typed+=r,t.totalChars++,n<t.current.length&&r===t.current[n]&&t.correctChars++,t.typed===t.current?this.loadNextSentence():this.renderTest()}}renderResults(){this.rootEl.innerHTML=`
      <div style="max-width:700px;margin:2rem auto;text-align:center;">
        <h2>Results</h2>
        <div style="margin:3rem 0;font-size:1.5rem;line-height:2;">
          ${this.state.resultsText}
        </div>
        <p class="muted">Follow the instructions above</p>
      </div>
    `}handleResultsKey(e){if(e.key==="Escape"){this.showMenu();return}if(e.key===" "&&(e.preventDefault(),this.state.resultsText.includes("stage"))){const t=Math.min(this.state.lesson.stage+1,h.length-1);this.state.lesson.stage=t,E(t),this.startLesson()}e.key==="Enter"&&(e.preventDefault(),this.state.resultsText.includes("Speed test")?this.startTest():(E(this.state.lesson.stage),this.startLesson()))}}function S(){v(),L(),new R().start()}document.readyState!=="loading"?S():window.addEventListener("DOMContentLoaded",S);
